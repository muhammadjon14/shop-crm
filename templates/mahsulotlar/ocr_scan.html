{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --bg-color: #f9fafb;
        --card-bg: #ffffff;
        --text-main: #111827;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --success: #10b981;
        --danger: #ef4444;
    }

    .ocr-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .ocr-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .ocr-header h1 {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-main);
        margin-bottom: 0.5rem;
        background: linear-gradient(to right, var(--primary-color), #818cf8);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .ocr-card {
        background: var(--card-bg);
        border-radius: 1rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fcfcfd;
    }

    .upload-zone:hover {
        border-color: var(--primary-color);
        background: #f5f3ff;
    }

    .upload-icon {
        font-size: 2.5rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    #image-input {
        display: none;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: var(--text-main);
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .loading-spinner {
        display: none;
        width: 2rem;
        height: 2rem;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 1rem auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .results-section {
        display: none;
        margin-top: 1.5rem;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .results-header h3 {
        margin: 0;
        font-weight: 700;
    }

    .results-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .product-table {
        width: 100%;
        border-collapse: collapse;
    }

    .product-table th,
    .product-table td {
        padding: 0.75rem 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .product-table th {
        background: #f9fafb;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.05em;
        white-space: nowrap;
    }

    .product-table td {
        vertical-align: middle;
    }

    .editable-input {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
        font-size: 0.85rem;
    }

    .editable-input:focus {
        outline: 2px solid var(--primary-color);
        border-color: transparent;
    }

    .name-input {
        min-width: 180px;
    }

    .price-input,
    .qty-input {
        width: 80px;
    }

    .preview-img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: none;
    }

    .segmented-control {
        display: flex;
        background: #f1f3f5;
        padding: 3px;
        border-radius: 6px;
        width: fit-content;
        flex-wrap: wrap;
        gap: 2px;
    }

    .segmented-control input[type="radio"] {
        display: none;
    }

    .segmented-control label {
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 0.7rem;
        margin-bottom: 0;
        white-space: nowrap;
    }

    .segmented-control input[type="radio"]:checked+label {
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        color: var(--primary-color);
    }

    .delete-btn {
        padding: 0.4rem 0.6rem;
        background: #fee2e2;
        color: var(--danger);
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .delete-btn:hover {
        background: #fecaca;
    }

    .footer-actions {
        margin-top: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .product-count {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .footer-buttons {
        display: flex;
        gap: 0.75rem;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal h3 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
    }

    .modal-form .form-group {
        margin-bottom: 1rem;
    }

    .modal-form label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }

    .modal-form input,
    .modal-form select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
    }

    .modal-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
    }

    @media (max-width: 768px) {
        .product-table {
            font-size: 0.85rem;
        }

        .segmented-control label {
            padding: 3px 6px;
            font-size: 0.65rem;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="ocr-container">
    <div class="ocr-header">
        <h1>üì∏ OCR Mahsulot Skaneri</h1>
        <p style="color: var(--text-muted)">Chek yoki mahsulotlar ro'yxatini rasmga oling va avtomatik qo'shing</p>
    </div>

    <div class="ocr-card">
        <form id="ocr-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="upload-zone" onclick="document.getElementById('image-input').click()">
                <div class="upload-icon">üì∑</div>
                <p id="upload-text">Rasm yuklash yoki rasmga olish uchun bosing</p>
                <img id="image-preview" class="preview-img" alt="Preview">
                <input type="file" id="image-input" name="image" accept="image/*" capture="environment"
                    onchange="handleFileSelect(event)">
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary" id="scan-btn" disabled>
                    <span>üîç Skanerlash</span>
                </button>
            </div>
        </form>

        <div class="loading-spinner" id="spinner"></div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <h3>üìã Aniqlangan mahsulotlar</h3>
                <div class="results-actions">
                    <button class="btn btn-secondary" onclick="toggleRawText()">üìÑ Raw</button>
                    <button class="btn btn-primary" onclick="openAddModal()">‚ûï Qo'shish</button>
                </div>
            </div>

            <div id="raw-text-container" style="display: none; margin-bottom: 1rem;">
                <textarea id="raw-text-display"
                    style="width: 100%; height: 120px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-family: monospace; font-size: 0.75rem;"
                    readonly></textarea>
            </div>

            <div style="overflow-x: auto;">
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>Mahsulot nomi</th>
                            <th>Narxi</th>
                            <th>Soni</th>
                            <th>Litr</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="product-list">
                    </tbody>
                </table>
            </div>

            <div class="footer-actions">
                <span class="product-count" id="product-count">0 ta mahsulot</span>
                <div class="footer-buttons">
                    <button class="btn btn-secondary" onclick="resetForm()">‚ùå Bekor</button>
                    <button class="btn btn-success" onclick="saveProducts()">üíæ Saqlash</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal-overlay" id="add-modal">
    <div class="modal">
        <h3>‚ûï Yangi mahsulot qo'shish</h3>
        <div class="modal-form">
            <div class="form-group">
                <label>Mahsulot nomi</label>
                <input type="text" id="modal-name" placeholder="Mahsulot nomi">
            </div>
            <div class="form-group">
                <label>Narxi</label>
                <input type="number" id="modal-price" placeholder="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Miqdori</label>
                <input type="number" id="modal-qty" placeholder="1" value="1">
            </div>
            <div class="form-group">
                <label>Litr</label>
                <select id="modal-litre">
                    <option value="none">N/A</option>
                    <option value="0.29">0.29L</option>
                    <option value="0.33">0.33L</option>
                    <option value="0.45">0.45L</option>
                    <option value="0.5">0.5L</option>
                    <option value="0.7">0.7L</option>
                    <option value="1.0">1L</option>
                    <option value="1.5">1.5L</option>
                    <option value="2.0">2L</option>
                    <option value="5.0">5L</option>
                </select>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeAddModal()">Bekor</button>
            <button class="btn btn-primary" onclick="addManualProduct()">Qo'shish</button>
        </div>
    </div>
</div>

<script>
    let scannedProducts = [];

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('image-preview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('upload-text').style.display = 'none';
                document.getElementById('scan-btn').disabled = false;
            }
            reader.readAsDataURL(file);
        }
    }

    document.getElementById('ocr-form').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const spinner = document.getElementById('spinner');
        const resultsSection = document.getElementById('results-section');
        const scanBtn = document.getElementById('scan-btn');

        spinner.style.display = 'block';
        resultsSection.style.display = 'none';
        scanBtn.disabled = true;

        try {
            const response = await fetch('{% url "mahsulotlar:ocr_scan" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const data = await response.json();
            if (data.error) {
                alert('Xato: ' + data.error);
            } else {
                displayResults(data.products, data.raw_text);
            }
        } catch (error) {
            alert('Skanerlashda xato yuz berdi');
        } finally {
            spinner.style.display = 'none';
            scanBtn.disabled = false;
        }
    };

    function displayResults(products, rawText) {
        const list = document.getElementById('product-list');
        list.innerHTML = '';
        scannedProducts = products;

        if (rawText) {
            document.getElementById('raw-text-display').value = rawText;
        }

        updateProductCount();

        if (products.length === 0) {
            list.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">Mahsulotlar aniqlanmadi. "Raw" tugmasini bosib tekshiring yoki "Qo\'shish" tugmasi bilan qo\'lda qo\'shing.</td></tr>';
        } else {
            products.forEach((p, index) => {
                const tr = document.createElement('tr');
                const litre = p.litre || 'none';
                tr.innerHTML = `
                    <td><input type="text" class="editable-input name-input" value="${escapeHtml(p.nomi)}" onchange="updateProduct(${index}, 'nomi', this.value)"></td>
                    <td><input type="number" step="0.01" class="editable-input price-input" value="${p.narx}" onchange="updateProduct(${index}, 'narx', this.value)"></td>
                    <td><input type="number" class="editable-input qty-input" value="${p.miqdor}" onchange="updateProduct(${index}, 'miqdor', this.value)"></td>
                    <td>
                        <div class="segmented-control">
                            <input type="radio" name="litre-${index}" id="l029-${index}" value="0.29" ${litre === '0.29' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '0.29')">
                            <label for="l029-${index}">0.29</label>
                            
                            <input type="radio" name="litre-${index}" id="l033-${index}" value="0.33" ${litre === '0.33' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '0.33')">
                            <label for="l033-${index}">0.33</label>
                            
                            <input type="radio" name="litre-${index}" id="l045-${index}" value="0.45" ${litre === '0.45' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '0.45')">
                            <label for="l045-${index}">0.45</label>
                            
                            <input type="radio" name="litre-${index}" id="l05-${index}" value="0.5" ${litre === '0.5' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '0.5')">
                            <label for="l05-${index}">0.5</label>
                            
                            <input type="radio" name="litre-${index}" id="l07-${index}" value="0.7" ${litre === '0.7' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '0.7')">
                            <label for="l07-${index}">0.7</label>
                            
                            <input type="radio" name="litre-${index}" id="l1-${index}" value="1.0" ${litre === '1.0' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '1.0')">
                            <label for="l1-${index}">1L</label>
                            
                            <input type="radio" name="litre-${index}" id="l15-${index}" value="1.5" ${litre === '1.5' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '1.5')">
                            <label for="l15-${index}">1.5</label>
                            
                            <input type="radio" name="litre-${index}" id="l2-${index}" value="2.0" ${litre === '2.0' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '2.0')">
                            <label for="l2-${index}">2L</label>
                            
                            <input type="radio" name="litre-${index}" id="l5-${index}" value="5.0" ${litre === '5.0' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', '5.0')">
                            <label for="l5-${index}">5L</label>
                            
                            <input type="radio" name="litre-${index}" id="lnone-${index}" value="none" ${litre === 'none' ? 'checked' : ''} onchange="updateProduct(${index}, 'litre', 'none')">
                            <label for="lnone-${index}">N/A</label>
                        </div>
                    </td>
                    <td><button class="delete-btn" onclick="removeProduct(${index})">üóëÔ∏è</button></td>
                `;
                list.appendChild(tr);
            });
        }

        document.getElementById('results-section').style.display = 'block';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function toggleRawText() {
        const container = document.getElementById('raw-text-container');
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }

    function updateProduct(index, field, value) {
        scannedProducts[index][field] = value;
    }

    function removeProduct(index) {
        scannedProducts.splice(index, 1);
        displayResults(scannedProducts, document.getElementById('raw-text-display').value);
    }

    function updateProductCount() {
        document.getElementById('product-count').textContent = scannedProducts.length + ' ta mahsulot';
    }

    function openAddModal() {
        document.getElementById('add-modal').classList.add('active');
        document.getElementById('modal-name').value = '';
        document.getElementById('modal-price').value = '';
        document.getElementById('modal-qty').value = '1';
        document.getElementById('modal-litre').value = 'none';
        document.getElementById('modal-name').focus();
    }

    function closeAddModal() {
        document.getElementById('add-modal').classList.remove('active');
    }

    function addManualProduct() {
        const name = document.getElementById('modal-name').value.trim();
        const price = document.getElementById('modal-price').value;
        const qty = document.getElementById('modal-qty').value || 1;
        const litre = document.getElementById('modal-litre').value;

        if (!name) {
            alert('Mahsulot nomini kiriting');
            return;
        }
        if (!price) {
            alert('Narxni kiriting');
            return;
        }

        scannedProducts.push({
            nomi: name,
            narx: price,
            miqdor: qty,
            litre: litre
        });

        closeAddModal();
        displayResults(scannedProducts, document.getElementById('raw-text-display').value);
    }

    async function saveProducts() {
        if (scannedProducts.length === 0) {
            alert('Saqlash uchun mahsulotlar yo\'q');
            return;
        }

        if (!confirm(`${scannedProducts.length} ta mahsulotni saqlashni tasdiqlaysizmi?`)) {
            return;
        }

        try {
            const response = await fetch('{% url "mahsulotlar:bulk_create" %}', {
                method: 'POST',
                body: JSON.stringify({ products: scannedProducts }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const data = await response.json();
            if (data.status === 'success') {
                alert(`${data.created_count} ta mahsulot muvaffaqiyatli saqlandi!`);
                window.location.href = "{% url 'admin_product_list' %}";
            } else {
                alert('Saqlashda xato: ' + data.error);
            }
        } catch (error) {
            alert('Saqlashda xato yuz berdi');
        }
    }

    function resetForm() {
        if (scannedProducts.length > 0 && !confirm('Barcha o\'zgarishlarni bekor qilmoqchimisiz?')) {
            return;
        }
        document.getElementById('ocr-form').reset();
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('upload-text').style.display = 'block';
        document.getElementById('results-section').style.display = 'none';
        document.getElementById('scan-btn').disabled = true;
        scannedProducts = [];
    }

    // Close modal on outside click
    document.getElementById('add-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeAddModal();
        }
    });

    // Handle Enter key in modal
    document.getElementById('modal-price').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            addManualProduct();
        }
    });
</script>
{% endblock %}