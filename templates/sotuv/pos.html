{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
    :root {
        --primary: #4f46e5;
        /* Darker primary */
        --primary-dark: #4338ca;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --bg-main: #f1f5f9;
        --card-bg: #ffffff;
        --text-main: #020617;
        /* Almost black */
        --text-muted: #334155;
        /* Darker gray */
        --border: #cbd5e1;
        /* Darker border */
        --radius: 12px;
    }

    body {
        background-color: var(--bg-main);
        font-family: 'Plus Jakarta Sans', sans-serif;
        color: var(--text-main);
    }

    /* Busy Mode - No animations */
    body.busy-mode * {
        animation: none !important;
        transition: none !important;
    }

    .pos-wrapper {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 15px;
        padding: 15px;
        max-width: 1800px;
        margin: 0 auto;
        height: calc(100vh - 100px);
    }

    /* Left Side: Products */
    .products-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        overflow: hidden;
    }

    .search-header {
        background: white;
        padding: 12px;
        border-radius: var(--radius);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .search-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
    }

    .search-input {
        flex: 1;
        padding: 16px 20px;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 20px;
        font-weight: 600;
        transition: all 0.1s;
        outline: none;
        color: var(--text-main);
    }

    .barcode-input {
        flex: 1;
        padding: 16px 20px;
        border: 2px solid var(--primary);
        border-radius: 10px;
        font-size: 20px;
        font-weight: 600;
        outline: none;
        color: var(--text-main);
        background: #f8faff;
    }

    .barcode-input::placeholder {
        color: var(--text-muted);
    }

    .barcode-scan-btn {
        padding: 16px 24px;
        border-radius: 10px;
        border: 2px solid var(--primary);
        background: var(--primary);
        color: white;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.1s;
    }

    .barcode-scan-btn:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .barcode-scan-btn.scanning {
        background: var(--danger);
        border-color: var(--danger);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    /* Barcode Scanner Modal */
    .scanner-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .scanner-modal.active {
        display: flex;
    }

    .scanner-container {
        position: relative;
        width: 90%;
        max-width: 600px;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    #scanner-video {
        width: 100%;
        height: auto;
        display: block;
    }

    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 3px solid var(--primary);
        border-radius: 12px;
        pointer-events: none;
    }

    .scanner-overlay::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        bottom: 20px;
        border: 2px dashed rgba(255, 255, 255, 0.5);
        border-radius: 8px;
    }

    .scanner-controls {
        padding: 20px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    .scanner-close-btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: 2px solid var(--danger);
        background: var(--danger);
        color: white;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
    }

    .scanner-status {
        flex: 1;
        text-align: center;
        font-weight: 600;
        color: var(--text-main);
    }

    .scanner-status.scanning {
        color: var(--primary);
    }

    .scanner-status.success {
        color: var(--success);
    }

    .scanner-status.error {
        color: var(--danger);
    }

    .search-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .busy-toggle {
        padding: 14px 20px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
        transition: all 0.15s;
        color: var(--text-main);
    }

    .busy-toggle.active {
        background: var(--warning);
        border-color: var(--warning);
        color: white;
    }

    .shortcut-hint {
        font-size: 12px;
        color: var(--text-muted);
        text-align: right;
    }

    .shortcut-hint kbd {
        background: #e2e8f0;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        color: var(--text-main);
    }

    /* Category Filter */
    .category-filter {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 5px 0;
        scrollbar-width: none;
    }

    .category-filter::-webkit-scrollbar {
        display: none;
    }

    .category-btn {
        padding: 10px 18px;
        border-radius: 20px;
        border: 1px solid var(--border);
        background: white;
        white-space: nowrap;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.15s;
        color: var(--text-muted);
    }

    .category-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        overflow-y: auto;
        padding-bottom: 15px;
    }

    /* Larger touch targets for speed - optimized for busy hours */
    .product-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid var(--border);
        cursor: pointer;
        transition: all 0.05s;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 120px;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        position: relative;
    }

    .product-card:hover:not(.out-of-stock) {
        border-color: var(--primary);
        background: #f8faff;
    }

    .product-card:active:not(.out-of-stock) {
        transform: scale(0.97);
        background: #eef2ff;
    }

    .product-card.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .product-name {
        font-weight: 800;
        color: var(--text-main);
        font-size: 1.3rem;
        line-height: 1.2;
        margin-bottom: 6px;
    }

    .product-price {
        color: var(--primary);
        font-weight: 800;
        font-size: 1.5rem;
        margin-top: auto;
    }

    /* Low stock warning */
    .low-stock-badge {
        background: var(--warning);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .out-of-stock-badge {
        background: var(--danger);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    /* Right Side: Cart */
    .cart-panel {
        background: white;
        border-radius: var(--radius);
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .cart-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cart-header h2 {
        margin: 0;
        font-weight: 800;
        font-size: 1.3rem;
        color: var(--text-main);
    }

    .cart-count {
        background: var(--primary);
        color: white;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 700;
    }

    .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.1s;
        text-decoration: none;
        color: var(--text-main);
    }

    .icon-btn:hover {
        background: var(--bg-main);
    }

    .cart-items {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f8fafc;
    }

    .item-info {
        flex: 1;
        min-width: 0;
    }

    .item-name {
        font-weight: 600;
        font-size: 1rem;
        /* Larger */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-main);
    }

    .item-price {
        font-size: 0.9rem;
        /* Larger */
        color: var(--text-muted);
    }

    .item-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .qty-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: 2px solid var(--border);
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.3rem;
        transition: all 0.05s;
        color: var(--text-main);
    }

    .qty-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .qty-btn:active {
        transform: scale(0.95);
    }

    .qty-display {
        min-width: 30px;
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-main);
    }

    .cart-footer {
        padding: 20px;
        background: #f8fafc;
        border-top: 1px solid var(--border);
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .total-label {
        font-weight: 600;
        color: var(--text-muted);
    }

    .total-amount {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--primary);
    }

    .checkout-btn {
        width: 100%;
        padding: 22px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: white;
        font-weight: 800;
        font-size: 1.3rem;
        cursor: pointer;
        transition: all 0.05s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        min-height: 60px;
    }

    .checkout-btn:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .checkout-btn:active:not(:disabled) {
        transform: scale(0.98);
    }

    .checkout-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
    }

    .checkout-btn kbd {
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }

    .empty-cart i {
        font-size: 3rem;
        display: block;
        margin-bottom: 10px;
    }

    /* Quick animations (disabled in busy mode) */
    @keyframes quickPop {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
        }
    }

    .cart-item.just-added {
        animation: quickPop 0.15s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <!-- Products Section -->
    <div class="products-container">
        <div class="search-header">
            <div class="search-row">
                <input type="text" id="barcode-input" class="barcode-input" placeholder="Barcode yoki mahsulot nomi..."
                    autofocus>
                <button class="barcode-scan-btn" id="barcode-scan-btn" title="Kameradan barcode skanerlash">
                    üì∑ Skaner
                </button>
                <input type="text" id="product-search" class="search-input"
                    placeholder="Mahsulot qidirish... (/ tugmasini bosing)">
                <button class="busy-toggle" id="busy-toggle" title="Tez rejim - animatsiyalarni o'chiradi">
                    ‚ö° Tez
                </button>
            </div>
            <div class="shortcut-hint">
                <kbd>/</kbd> Qidirish &nbsp; <kbd>Esc</kbd> Tozalash &nbsp; <kbd>Enter</kbd> Sotish &nbsp; <kbd>F2</kbd>
                Skaner
            </div>

            <div class="category-filter" id="category-filter">
                <button class="category-btn active" data-category="all">Barchasi</button>
                {% for cat in categories %}
                <button class="category-btn" data-category="{{ cat.id }}">{{ cat.nomi }}</button>
                {% endfor %}
            </div>
        </div>

        <div class="products-grid" id="products-grid">
            {% for product in products %}
            <div class="product-card {% if product.miqdor <= 0 %}out-of-stock{% endif %}" data-id="{{ product.id }}"
                data-name="{{ product.nomi }}" data-price="{{ product.narx|stringformat:'.2f' }}"
                data-stock="{{ product.miqdor }}" data-category="{{ product.turi_id|default:'' }}"
                data-barcode="{{ product.barcode|default:'' }}">

                <div class="product-name">{{ product.nomi }}</div>
                <div class="product-price">{{ product.narx }} so'm</div>

                {% if product.miqdor <= 0 %} <span class="out-of-stock-badge">Tugadi</span>
                    {% elif product.miqdor < 5 %} <span class="low-stock-badge">{{ product.miqdor }} ta qoldi</span>
                        {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Cart Section -->
    <div class="cart-panel">
        <div class="cart-header">
            <h2>Savat <span class="cart-count" id="cart-count">0</span></h2>
            <div class="header-actions">
                {% if user.is_superuser %}
                <a href="{% url 'admin_dashboard' %}" class="icon-btn" title="Admin panel">‚öôÔ∏è</a>
                {% endif %}
                <a href="/admin/logout/" class="icon-btn" title="Chiqish">üö™</a>
                <button class="icon-btn" onclick="clearCart()" title="Tozalash (Esc)">üóëÔ∏è</button>
            </div>
        </div>

        <div class="cart-items" id="cart-items">
            <div class="empty-cart">
                <i>üõí</i>
                Savat bo'sh
            </div>
        </div>

        <div class="cart-footer">
            <div class="total-row">
                <span class="total-label">Jami summa:</span>
                <span class="total-amount" id="total-price">0</span>
            </div>

            <button type="button" class="checkout-btn" id="checkout-btn" disabled>
                <span>Sotuvni yakunlash</span>
                <kbd>Enter</kbd>
            </button>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="scanner-modal" id="scanner-modal">
    <div class="scanner-container">
        <video id="scanner-video" autoplay playsinline></video>
        <div class="scanner-overlay"></div>
        <div class="scanner-controls">
            <button class="scanner-close-btn" id="scanner-close-btn">‚úï Yopish</button>
            <div class="scanner-status" id="scanner-status">Kamerani ko'rsating...</div>
        </div>
    </div>
</div>

<script>
    // Pre-load products data
    let cart = [];
    let currentCategory = 'all';
    let searchTimeout = null;

    // Busy mode toggle
    const busyToggle = document.getElementById('busy-toggle');
    const busyMode = localStorage.getItem('busyMode') === 'true';
    if (busyMode) {
        document.body.classList.add('busy-mode');
        busyToggle.classList.add('active');
    }

    busyToggle.addEventListener('click', function () {
        document.body.classList.toggle('busy-mode');
        this.classList.toggle('active');
        localStorage.setItem('busyMode', document.body.classList.contains('busy-mode'));
    });

    // Barcode scanning with webcam
    let codeReader = null;
    let scanning = false;
    let stream = null;
    const barcodeInput = document.getElementById('barcode-input');
    const barcodeScanBtn = document.getElementById('barcode-scan-btn');
    const scannerModal = document.getElementById('scanner-modal');
    const scannerVideo = document.getElementById('scanner-video');
    const scannerCloseBtn = document.getElementById('scanner-close-btn');
    const scannerStatus = document.getElementById('scanner-status');

    // Initialize ZXing code reader
    if (typeof ZXing !== 'undefined') {
        codeReader = new ZXing.BrowserMultiFormatReader();
    }

    // Manual barcode input (for keyboard scanners or manual entry)
    let barcodeTimeout = null;
    barcodeInput.addEventListener('input', function (e) {
        clearTimeout(barcodeTimeout);
        barcodeTimeout = setTimeout(async function () {
            const barcode = barcodeInput.value.trim();
            if (barcode.length >= 3) {
                await searchAndAddProduct(barcode);
                barcodeInput.value = '';
                barcodeInput.focus();
            }
        }, 300);
    });

    // Open scanner modal
    barcodeScanBtn.addEventListener('click', function () {
        if (!codeReader) {
            alert('Barcode skaner kutubxonasi yuklanmagan. Iltimos, sahifani yangilang.');
            return;
        }
        openScanner();
    });

    // Close scanner
    scannerCloseBtn.addEventListener('click', function () {
        closeScanner();
    });

    // Close on Escape
    scannerModal.addEventListener('click', function (e) {
        if (e.target === scannerModal) {
            closeScanner();
        }
    });

    async function openScanner() {
        scannerModal.classList.add('active');
        barcodeScanBtn.classList.add('scanning');
        scannerStatus.textContent = 'Kamerani yoqilmoqda...';
        scannerStatus.className = 'scanner-status';

        try {
            const videoInputDevices = await codeReader.listVideoInputDevices();

            if (videoInputDevices.length === 0) {
                scannerStatus.textContent = 'Kamera topilmadi!';
                scannerStatus.className = 'scanner-status error';
                return;
            }

            // Use first available camera (usually the default one)
            const selectedDeviceId = videoInputDevices[0].deviceId;

            scannerStatus.textContent = 'Barcode skanerlash...';
            scannerStatus.className = 'scanner-status scanning';

            scanning = true;

            // Start scanning
            codeReader.decodeFromVideoDevice(selectedDeviceId, 'scanner-video', (result, err) => {
                if (result) {
                    // Barcode found!
                    const barcode = result.getText();
                    scannerStatus.textContent = `Topildi: ${barcode}`;
                    scannerStatus.className = 'scanner-status success';

                    // Stop scanning
                    scanning = false;
                    codeReader.reset();

                    // Close scanner and add product
                    setTimeout(async () => {
                        closeScanner();
                        await searchAndAddProduct(barcode);
                    }, 500);
                }

                if (err && err.name !== 'NotFoundException') {
                    console.error('Scanning error:', err);
                }
            });

        } catch (err) {
            console.error('Camera error:', err);
            scannerStatus.textContent = 'Kameraga kirish rad etildi!';
            scannerStatus.className = 'scanner-status error';
            scanning = false;
        }
    }

    function closeScanner() {
        if (codeReader && scanning) {
            codeReader.reset();
            scanning = false;
        }

        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }

        scannerModal.classList.remove('active');
        barcodeScanBtn.classList.remove('scanning');
        scannerVideo.srcObject = null;
        scannerStatus.textContent = 'Kamerani ko\'rsating...';
        scannerStatus.className = 'scanner-status';
    }

    async function searchAndAddProduct(barcode) {
        try {
            const response = await fetch(`{% url "search_barcode" %}?barcode=${encodeURIComponent(barcode)}`);
            const data = await response.json();
            if (data.status === 'success') {
                const product = data.product;
                addToCart(
                    product.id,
                    product.name,
                    parseFloat(product.price),
                    product.stock
                );
                showQuickMessage(`‚úì ${product.name} qo'shildi`);
            } else {
                // Product not found, try searching by name
                document.getElementById('product-search').value = barcode;
                filterProducts();
                showQuickMessage('Barcode topilmadi, qidiruvda ko\'rsatildi');
            }
        } catch (err) {
            console.error('Barcode search error:', err);
            showQuickMessage('Xatolik yuz berdi');
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        const isInputFocused = document.activeElement.tagName === 'INPUT' ||
            document.activeElement.tagName === 'SELECT' ||
            document.activeElement.tagName === 'TEXTAREA';

        if (e.key === 'F2') {
            e.preventDefault();
            barcodeScanBtn.click();
            return;
        }

        if (e.key === '/' && !isInputFocused) {
            e.preventDefault();
            document.getElementById('product-search').focus();
            return;
        }

        if (e.key === 'Escape') {
            // Close scanner if open
            if (scannerModal.classList.contains('active')) {
                closeScanner();
                return;
            }

            const searchInput = document.getElementById('product-search');
            if (searchInput.value) {
                searchInput.value = '';
                filterProducts();
                searchInput.blur();
            } else if (cart.length > 0) {
                clearCart();
            }
            return;
        }

        if (e.key === 'Enter' && cart.length > 0) {
            const checkoutBtn = document.getElementById('checkout-btn');
            if (!checkoutBtn.disabled) {
                e.preventDefault();
                checkoutBtn.click();
            }
            return;
        }
    });

    // Product click handler
    document.getElementById('products-grid').addEventListener('click', (e) => {
        const card = e.target.closest('.product-card');
        if (!card || card.classList.contains('out-of-stock')) return;

        const id = parseInt(card.dataset.id);
        const name = card.dataset.name;
        const price = parseFloat(card.dataset.price);
        const stock = parseInt(card.dataset.stock);

        addToCart(id, name, price, stock);
    });

    // Category Filtering
    document.getElementById('category-filter').addEventListener('click', (e) => {
        const btn = e.target.closest('.category-btn');
        if (!btn) return;

        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCategory = btn.dataset.category;
        filterProducts();
    });

    // Debounced search
    document.getElementById('product-search').addEventListener('input', function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterProducts, 150);
    });

    function filterProducts() {
        const query = document.getElementById('product-search').value.toLowerCase().trim();
        const cards = document.querySelectorAll('.product-card');

        cards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const barcode = (card.dataset.barcode || '').toLowerCase();
            const category = card.dataset.category;

            const matchesSearch = !query || name.includes(query) || barcode.includes(query);
            const matchesCategory = currentCategory === 'all' || category === currentCategory;

            card.style.display = (matchesSearch && matchesCategory) ? 'flex' : 'none';
        });
    }

    function addToCart(id, name, price, stock) {
        // Create unique ID for cart item based on product ID
        const cartItemId = `${id}`;
        const existingItem = cart.find(item => item.cartItemId === cartItemId);

        if (existingItem) {
            // Check total stock for this product ID across all cart items
            const totalInCart = cart.filter(i => i.id === id).reduce((sum, i) => sum + i.quantity, 0);

            if (totalInCart < stock) {
                existingItem.quantity += 1;
            } else {
                showQuickMessage('Omborda boshqa mahsulot yo\'q!');
                return;
            }
        } else {
            // Check total stock first
            const totalInCart = cart.filter(i => i.id === id).reduce((sum, i) => sum + i.quantity, 0);
            if (totalInCart >= stock) {
                showQuickMessage('Omborda boshqa mahsulot yo\'q!');
                return;
            }

            cart.push({
                cartItemId,
                id,
                name,
                price,
                quantity: 1,
                stock
            });
        }
        renderCart(cartItemId);
    }

    function updateQuantity(cartItemId, delta) {
        const item = cart.find(item => item.cartItemId === cartItemId);
        if (item) {
            const newQty = item.quantity + delta;

            // Check stock limit
            const totalInCart = cart.filter(i => i.id === item.id).reduce((sum, i) => sum + i.quantity, 0);
            // If increasing, check if we have room
            if (delta > 0 && totalInCart >= item.stock) {
                showQuickMessage('Omborda boshqa mahsulot yo\'q!');
                return;
            }

            if (newQty > 0) {
                item.quantity = newQty;
            } else if (newQty === 0) {
                cart = cart.filter(i => i.cartItemId !== cartItemId);
            }
        }
        renderCart();
    }

    function clearCart() {
        if (cart.length > 0) {
            cart = [];
            renderCart();
        }
    }

    function renderCart(justAddedId = null) {
        const container = document.getElementById('cart-items');
        const priceEl = document.getElementById('total-price');
        const checkoutBtn = document.getElementById('checkout-btn');
        const countEl = document.getElementById('cart-count');

        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        countEl.textContent = totalItems;

        if (cart.length === 0) {
            container.innerHTML = '<div class="empty-cart"><i>üõí</i>Savat bo\'sh</div>';
            priceEl.innerText = '0';
            checkoutBtn.disabled = true;
            return;
        }

        let totalPrice = 0;
        container.innerHTML = cart.map(item => {
            totalPrice += item.price * item.quantity;
            const isJustAdded = item.cartItemId === justAddedId;
            // Handle string vs number for cartItemId
            const updateId = typeof item.cartItemId === 'string' ? `'${item.cartItemId}'` : item.cartItemId;

            return `
                <div class="cart-item ${isJustAdded ? 'just-added' : ''}">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">${item.price.toLocaleString()} √ó ${item.quantity} = ${(item.price * item.quantity).toLocaleString()} so'm</div>
                    </div>
                    <div class="item-controls">
                        <button class="qty-btn" onclick="updateQuantity(${updateId}, -1)">‚àí</button>
                        <span class="qty-display">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${updateId}, 1)">+</button>
                    </div>
                </div>
            `;
        }).join('');

        priceEl.innerText = totalPrice.toLocaleString() + " so'm";
        checkoutBtn.disabled = false;
    }

    function showQuickMessage(msg) {
        // Create a temporary notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        `;
        notification.textContent = msg;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }

    // Add notification animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // Checkout
    document.getElementById('checkout-btn').addEventListener('click', async () => {
        const btn = document.getElementById('checkout-btn');
        btn.disabled = true;
        btn.innerHTML = '<span>Saqlanmoqda...</span>';

        try {
            const response = await fetch('{% url "create_sale" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    items: cart
                })
            });

            const data = await response.json();
            if (data.status === 'success') {
                // Redirect to receipt page
                window.location.href = `/sotuv/${data.sale_id}/receipt/`;
            } else {
                alert('Xatolik: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<span>Sotuvni yakunlash</span> <kbd>Enter</kbd>';
            }
        } catch (e) {
            alert('Xatolik yuz berdi: ' + e);
            btn.disabled = false;
            btn.innerHTML = '<span>Sotuvni yakunlash</span> <kbd>Enter</kbd>';
        }
    });
</script>
{% endblock %}